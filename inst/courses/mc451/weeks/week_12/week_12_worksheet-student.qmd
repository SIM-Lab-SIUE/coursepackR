---
title: "Week 12 Worksheet: Advanced Data Wrangling Techniques"
subtitle: "Additional Examples for Preparing Survey Data"
format: html
editor: visual
---

> **Required Citation:** Pew Research Center, "Global Attitudes Spring 2024 Dataset." Pew Research Center, Washington, D.C. (May 2024) \[URL\]
>
> **Required Disclaimer:** Pew Research Center bears no responsibility for the analyses or interpretations of the data presented here. The opinions expressed herein, including any implications for policy, are those of the author and not of Pew Research Center.

## Introduction

This optional worksheet provides additional examples of data wrangling techniques beyond the main lab. Focus on advanced cleaning, recoding, and creating composite variables for public data preparation.

## Setup

```{r setup, message=FALSE, warning=FALSE}
library(tidyverse)
library(mccoursepack)
```

## 1. Loading and Initial Cleaning (Review)

Load the new teaching dataset and perform basic cleaning as in the lab.

```{r load-clean}
# Find the full path to the new data set inside the mccoursepack package
data_path <- system.file("extdata", "w144_teaching_dataset_v2.csv", package = "mccoursepack")
w144_data <- read_csv(data_path)

# Preview the data structure
glimpse(w144_data)

# For this worksheet, we'll assume the following columns exist (adjust as needed):
#   id, age, gender, education, ideology, party, uses_facebook, uses_x, uses_instagram, uses_tiktok,
#   fb_why_news, fb_why_family, fb_why_friends, fb_why_groups, fb_why_events, fb_why_entertainment, fb_why_other,
#   income, urban_rural, religion

w144_clean <- w144_data %>%
  mutate(
    gender = as_factor(gender),
    education = as_factor(education),
    income = as_factor(income),
    urban_rural = as_factor(urban_rural),
    religion = as_factor(religion),
    ideology = as.numeric(ideology)
  )
```

## 2. Advanced Recoding Techniques

### A. Creating Ordinal Scales from Categorical Data

Convert education levels to an ordinal numeric scale.

```{r recode-ordinal}
w144_clean <- w144_clean %>%
  mutate(
    education_ordinal = case_when(
      education == "No formal education" ~ 1,
      education == "Primary school" ~ 2,
      education == "Secondary school" ~ 3,
      education == "Some university" ~ 4,
      education == "University degree" ~ 5,
      education == "Post-graduate" ~ 6,
      TRUE ~ NA_real_
    )
  )
```

### B. Grouping Categories for Simplicity

Combine religion categories into broader groups.

```{r recode-group}
w144_clean <- w144_clean %>%
  mutate(
    religion_grouped = case_when(
      religion %in% c("Catholic", "Protestant", "Orthodox Christian") ~ "Christian",
      religion %in% c("Sunni Muslim", "Shia Muslim") ~ "Muslim",
      religion == "Jewish" ~ "Jewish",
      religion == "Hindu" ~ "Hindu",
      religion == "Buddhist" ~ "Buddhist",
      religion == "Atheist" ~ "Atheist",
      religion == "Agnostic" ~ "Agnostic",
      TRUE ~ "Other/None"
    )
  )
```

## 3. Creating Multiple Composite Scores

### A. Confidence in Western Leaders

Average confidence in Biden (US) vs. Putin and Xi (authoritarian).

```{r composite-platforms}
# Example: Create a composite score for number of platforms used
w144_clean <- w144_clean %>%
  mutate(
    platform_count = (uses_facebook == "Yes") +
      (uses_x == "Yes") +
      (uses_instagram == "Yes") +
      (uses_tiktok == "Yes")
  )
```

### B. Socioeconomic Status Index

Create a composite from education and income (treating as ordinal).

```{r composite-ses}
w144_clean <- w144_clean %>%
  mutate(
    income_ordinal = case_when(
      income == "Lower" ~ 1,
      income == "Working" ~ 2,
      income == "Middle" ~ 3,
      income == "Upper-Middle" ~ 4,
      income == "Upper" ~ 5,
      TRUE ~ NA_real_
    ),
    ses_index = rowMeans(select(., education_ordinal, income_ordinal), na.rm = TRUE)
  )
```

### C. Urban-Rural Ideology Scale

Combine urban/rural residence with ideology.

```{r composite-urban-ideology}
w144_clean <- w144_clean %>%
  mutate(
    urban_ideology = case_when(
      urban_rural == "Urban" & ideology <= 2 ~ "Urban Left",
      urban_rural == "Urban" & ideology >= 4 ~ "Urban Right",
      urban_rural == "Urban" & ideology == 3 ~ "Urban Center",
      urban_rural == "Rural" & ideology <= 2 ~ "Rural Left",
      urban_rural == "Rural" & ideology >= 4 ~ "Rural Right",
      urban_rural == "Rural" & ideology == 3 ~ "Rural Center",
      TRUE ~ NA_character_
    )
  )
```

## 4. Handling Missing Data in Composites

### A. Minimum Valid Responses for Composites

Only create composite if at least 2 out of 3 items are non-missing.

```{r composite-min-valid}
# Example: Only create composite if at least 2 out of 4 platforms are non-missing
w144_clean <- w144_clean %>%
  mutate(
    platform_nonmissing = rowSums(!is.na(select(., uses_facebook, uses_x, uses_instagram, uses_tiktok))),
    platform_count_valid = ifelse(platform_nonmissing >= 2,
      rowSums(select(., uses_facebook, uses_x, uses_instagram, uses_tiktok) == "Yes", na.rm = TRUE),
      NA_real_)
  )
```

### B. Imputation for Missing Values (Simple Mean Imputation)

Replace missing values with group means.

```{r imputation}
# Impute missing age and ideology by group (e.g., by party)
w144_clean <- w144_clean %>%
  group_by(party) %>%
  mutate(
    age_imputed = ifelse(is.na(age), mean(age, na.rm = TRUE), age),
    ideology_imputed = ifelse(is.na(ideology), mean(ideology, na.rm = TRUE), ideology)
  ) %>%
  ungroup()
```

## 5. Data Validation and Quality Checks

### A. Check for Logical Inconsistencies

Ensure age is reasonable and education levels make sense.

```{r validation}
w144_clean <- w144_clean %>%
  mutate(
    age_valid = age >= 18 & age <= 100,
    education_valid = !is.na(education_ordinal)
  )

# Summary of validation
w144_clean %>%
  summarize(
    total_cases = n(),
    valid_age = sum(age_valid, na.rm = TRUE),
    valid_education = sum(education_valid, na.rm = TRUE)
  )
```

### B. Outlier Detection

Identify outliers in continuous variables.

age_iqr <- age_q75 - age_q25
```{r outliers}
# Using IQR method for age
age_q25 <- quantile(w144_clean$age, 0.25, na.rm = TRUE)
age_q75 <- quantile(w144_clean$age, 0.75, na.rm = TRUE)
age_iqr <- age_q75 - age_q25

w144_clean <- w144_clean %>%
  mutate(
    age_outlier = age < (age_q25 - 1.5 * age_iqr) | age > (age_q75 + 1.5 * age_iqr)
  )
```

## 6. Preparing Data for Public Release

### A. Anonymization

Remove or generalize identifying information.

```{r anonymize}
w144_public <- w144_clean %>%
  select(-c(religion)) %>%  # Remove potentially identifying variables
  mutate(
    age_grouped = cut(age, breaks = c(0, 30, 50, 100), labels = c("18-30", "31-50", "51+"))
  ) %>%
  select(-age)  # Remove original age
```

### B. Create Metadata Summary

data_summary <- pew_public %>%
```{r metadata}
data_summary <- w144_public %>%
  summarize(
    n_observations = n(),
    n_variables = ncol(.),
    variables = paste(names(.), collapse = ", "),
    date_prepared = Sys.Date()
  )

print(data_summary)
```

### C. Save Cleaned Dataset

```{r save-clean}
write_csv(w144_public, "w144_data_advanced_clean.csv")
```

## Practice Exercises

1.  Create a composite score for "global confidence" using confidence in all three leaders (Biden, Putin, Xi).

2.  Recode the income variable into a 3-category system (Low, Medium, High).

3.  Handle missing data in the ideology variable using median imputation instead of mean.

4.  Create validation checks for the composite scores you created.

5.  Prepare a version of the dataset with different levels of aggregation (country-level summaries).</content> <parameter name="filePath">c:\Users\alexl\OneDrive - Southern Illinois University Edwardsville\Teaching\SIUE\\2025_Fall\MC451\mccoursepack\mccoursepack\inst\courses\mc451\weeks\week\_12\week\_12_worksheet-student.qmd